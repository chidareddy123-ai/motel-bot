<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AmericInn Hartford â€“ Guest Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
</head>

<body>
<div class="app">

  <!-- ===== HEADER ===== -->
  <header class="topbar">
    <div class="brand">
      <div class="brandTop">
        <h1>AmericInn Hartford</h1>
        <span class="badge">Guest Assistant</span>
      </div>
      <p id="roomLine">Room: â€”</p>
    </div>

    <div class="actions">
      <select id="langSelect" class="control">
        <option value="en">English</option>
        <option value="es">EspaÃ±ol</option>
      </select>

      <button id="infoBtn" class="control">Hotel Info</button>
      <button id="callBtn" class="control">Call</button>
      <button id="resetBtn" class="control">Reset</button>
    </div>
  </header>

  <!-- ===== CHAT ===== -->
  <main id="chat" class="chat"></main>

  <!-- ===== QUICK ACTIONS ===== -->
  <section class="quick">
    <button class="chip primary" data-msg="I need extra towels.">ğŸ§» Towels</button>
    <button class="chip" data-msg="I need toiletries like soap or shampoo.">ğŸ§¼ Toiletries</button>
    <button class="chip" data-msg="I have a maintenance issue in my room.">ğŸ”§ Maintenance</button>
    <button class="chip" data-msg="Can I request a late checkout?">â° Late checkout</button>
    <button class="chip" data-msg="I need Wi-Fi help.">ğŸ“¶ Wi-Fi help</button>
    <button class="chip" data-msg="I want to report a noise complaint.">ğŸ”‡ Noise</button>
  </section>

  <!-- ===== INPUT ===== -->
  <footer class="composer">
    <input id="input" type="text" placeholder="Type your messageâ€¦" />
    <button id="sendBtn" class="send">Send</button>
  </footer>

</div>

<script>
/* ================= CONFIG ================= */

const SHEET_LOG_URL =
  "https://script.google.com/macros/s/AKfycbzxatP2NITNy0X10cyUo3jl5gcQnTA6qbohTqyXZB8aBimmaQ89jVGy4O6GB25gYirvhA/exec";

const FRONT_DESK_PHONE = "2626732200";

/* ================= STATE ================= */

const chat = document.getElementById("chat");
const input = document.getElementById("input");

let room = new URLSearchParams(location.search).get("room")
        || localStorage.getItem("room") || "";

let lang = localStorage.getItem("lang") || "en";
let messages = JSON.parse(localStorage.getItem("messages") || "[]");

/* ================= INIT ================= */

if (!room) {
  room = prompt("Enter your room number:");
  if (room) localStorage.setItem("room", room);
}

document.getElementById("roomLine").textContent = room ? `Room: ${room}` : "Room: â€”";
document.getElementById("langSelect").value = lang;

/* ================= UI HELPERS ================= */

function bubble(text, who) {
  const el = document.createElement("div");
  el.className = `bubble ${who}`;
  el.textContent = text;
  chat.appendChild(el);
  chat.scrollTop = chat.scrollHeight;
}

function render() {
  chat.innerHTML = "";
  if (!messages.length) {
    bubble(
      lang === "es"
        ? "Â¡Hola! Puedo ayudarte con toallas, Wi-Fi, salida tardÃ­a y mantenimiento. Â¿QuÃ© necesitas?"
        : "Hi! Iâ€™m your hotel assistant. How can I help you today?",
      "bot"
    );
  } else {
    messages.forEach(m => bubble(m.content, m.role === "user" ? "you" : "bot"));
  }
}

render();

/* ================= LOGGING ================= */

function logToSheet(message) {
  fetch(SHEET_LOG_URL, {
    method: "POST",
    mode: "no-cors",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify({
      room,
      type: "Guest Message",
      message
    })
  }).catch(()=>{});
}

/* ================= SEND ================= */

async function send(text) {
  if (!text) return;

  messages.push({ role: "user", content: text });
  localStorage.setItem("messages", JSON.stringify(messages));
  bubble(text, "you");
  input.value = "";

  logToSheet(text);

  bubble(lang === "es" ? "Escribiendoâ€¦" : "Typingâ€¦", "bot");

  try {
    const res = await fetch("/.netlify/functions/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        room,
        messages: [
          ...messages.slice(-8),
          { role: "system", content: lang === "es" ? "Reply in Spanish." : "Reply in English." }
        ]
      })
    });

    const data = await res.json();
    chat.lastChild.remove();

    messages.push({ role: "assistant", content: data.reply });
    localStorage.setItem("messages", JSON.stringify(messages));
    bubble(data.reply, "bot");

  } catch {
    chat.lastChild.remove();
    bubble(lang === "es"
      ? "Error de red. Llame a recepciÃ³n."
      : "Network error. Please call the front desk.",
      "bot"
    );
  }
}

/* ================= EVENTS ================= */

document.getElementById("sendBtn").onclick = () => send(input.value.trim());
input.onkeydown = e => e.key === "Enter" && send(input.value.trim());

document.querySelectorAll(".chip").forEach(btn =>
  btn.onclick = () => send(btn.dataset.msg)
);

document.getElementById("resetBtn").onclick = () => {
  localStorage.removeItem("messages");
  messages = [];
  render();
};

document.getElementById("langSelect").onchange = e => {
  lang = e.target.value;
  localStorage.setItem("lang", lang);
  render();
};

document.getElementById("callBtn").onclick = () => {
  window.location.href = `tel:${FRONT_DESK_PHONE}`;
};

document.getElementById("infoBtn").onclick = () => {
  bubble(
    lang === "es"
      ? "ğŸ“ AmericInn Hartford\nCheck-in: 3 PM\nCheck-out: 11 AM\nWi-Fi: Connect@AmericInn (sin contraseÃ±a)\nDesayuno: 6â€“10 AM cerca de recepciÃ³n"
      : "ğŸ“ AmericInn Hartford\nCheck-in: 3:00 PM\nCheck-out: 11:00 AM\nWi-Fi: Connect@AmericInn (no password)\nBreakfast: 6â€“10 AM near front desk",
    "bot"
  );
};
</script>
</body>
</html>
