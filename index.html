<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AmericInn Hartford â€“ Guest Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
</head>

<body>
<div class="app">

  <header class="topbar">
    <div class="brand">
      <div class="brandTop">
        <h1>AmericInn Hartford</h1>
        <span class="badge">Guest Assistant</span>
      </div>
      <p id="roomLine">Room: â€”</p>
    </div>

    <div class="actions">
      <select id="langSelect" class="control">
        <option value="en">English</option>
        <option value="es">EspaÃ±ol</option>
      </select>
      <button id="infoBtn" class="control" type="button">Hotel Info</button>
      <button id="callBtn" class="control" type="button">Call</button>
      <button id="resetBtn" class="control" type="button">Reset</button>
    </div>
  </header>

  <main id="chat" class="chat"></main>

  <section class="quick">
    <button class="chip primary" type="button" id="towelBtn">ğŸ§» Need towels?</button>
    <button class="chip" type="button" data-msg="I have a maintenance issue in my room.">ğŸ”§ Maintenance</button>
    <button class="chip" type="button" data-msg="Can I request a late checkout?">â° Late checkout</button>
  </section>

  <footer class="composer">
    <input id="input" type="text" placeholder="Type your messageâ€¦" autocomplete="off" />
    <button id="sendBtn" class="send" type="button">Send</button>
  </footer>

</div>

<script>
const SHEET_LOG_URL =
  "https://script.google.com/macros/s/AKfycbzxatP2NITNy0X10cyUo3jl5gcQnTA6qbohTqyXZB8aBimmaQ89jVGy4O6GB25gYirvhA/exec";

const FRONT_DESK_PHONE = "2626732200";

const chat = document.getElementById("chat");
const input = document.getElementById("input");
const sendBtn = document.getElementById("sendBtn");
const resetBtn = document.getElementById("resetBtn");
const langSelect = document.getElementById("langSelect");
const infoBtn = document.getElementById("infoBtn");
const callBtn = document.getElementById("callBtn");

const params = new URLSearchParams(location.search);
let room = params.get("room") || localStorage.getItem("room") || "";
let lang = localStorage.getItem("lang") || "en";
let messages = JSON.parse(localStorage.getItem("messages") || "[]");

langSelect.value = lang;

if (!room) {
  room = (prompt("Enter your room number (example: 106):") || "").trim();
  if (room) localStorage.setItem("room", room);
}
document.getElementById("roomLine").textContent = room ? `Room: ${room}` : "Room: â€”";

function bubble(text, who) {
  const el = document.createElement("div");
  el.className = `bubble ${who}`;
  el.textContent = text;
  chat.appendChild(el);
  chat.scrollTop = chat.scrollHeight;
}

function renderHistory() {
  chat.innerHTML = "";
  if (messages.length === 0) {
    bubble(
      lang === "es"
        ? "Â¡Hola! Soy tu asistente del hotel. Â¿CÃ³mo puedo ayudarte?"
        : "Hi! Iâ€™m your hotel assistant. How can I help you?",
      "bot"
    );
  } else {
    messages.forEach(m => bubble(m.content, m.role === "user" ? "you" : "bot"));
  }
}

function detectType(text) {
  const t = (text || "").toLowerCase();
  if (t.includes("towel") || t.includes("toalla")) return "Towels";
  if (t.includes("maint") || t.includes("broken") || t.includes("repair") || t.includes("leak") || t.includes("ac")) return "Maintenance";
  if (t.includes("late checkout") || t.includes("checkout tarde") || t.includes("salida tarde")) return "Late checkout";
  return "Other";
}

function logToSheet({ room, type, message }) {
  if (!SHEET_LOG_URL) return;
  fetch(SHEET_LOG_URL, {
    method: "POST",
    mode: "no-cors",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify({ room, type, message })
  }).catch(() => {});
}

function languageInstruction() {
  return (lang === "es") ? "Please reply in Spanish." : "Please reply in English.";
}

async function sendMessage(text) {
  if (!text) return;

  messages.push({ role: "user", content: text });
  localStorage.setItem("messages", JSON.stringify(messages));
  bubble(text, "you");
  input.value = "";

  logToSheet({ room, type: detectType(text), message: text });

  bubble(lang === "es" ? "Escribiendoâ€¦" : "Typingâ€¦", "bot");
  const typingEl = chat.lastChild;

  try {
    const outgoing = [
      ...messages.slice(-8),
      { role: "user", content: languageInstruction() }
    ];

    const res = await fetch("/.netlify/functions/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ room, messages: outgoing })
    });

    const data = await res.json();
    typingEl.remove();

    const reply = data.reply || (lang === "es" ? "Lo sientoâ€”algo saliÃ³ mal." : "Sorryâ€”something went wrong.");
    messages.push({ role: "assistant", content: reply });
    localStorage.setItem("messages", JSON.stringify(messages));
    bubble(reply, "bot");
  } catch {
    typingEl.remove();
    bubble(
      lang === "es" ? "Error de red. Llama a recepciÃ³n." : "Network error. Please call the front desk.",
      "bot"
    );
  }
}

/* âœ… Make sure input can always be focused */
input.addEventListener("click", () => input.focus());

sendBtn.onclick = () => sendMessage(input.value.trim());
input.addEventListener("keydown", (e) => {
  if (e.key === "Enter") sendMessage(input.value.trim());
});

document.querySelectorAll(".chip[data-msg]").forEach(btn =>
  btn.onclick = () => sendMessage(btn.dataset.msg)
);

resetBtn.onclick = () => {
  localStorage.removeItem("messages");
  messages = [];
  renderHistory();
};

langSelect.onchange = e => {
  lang = e.target.value;
  localStorage.setItem("lang", lang);
  renderHistory();
};

callBtn.onclick = () => {
  window.location.href = `tel:${FRONT_DESK_PHONE}`;
};

infoBtn.onclick = () => {
  bubble(
    lang === "es"
      ? "ğŸ“ AmericInn Hartford\nCheck-in: 3:00 PM\nCheck-out: 11:00 AM\nWi-Fi: Connect@AmericInn (sin contraseÃ±a)\nDesayuno: 6â€“10 AM\nRecepciÃ³n: 262-673-2200"
      : "ğŸ“ AmericInn Hartford\nCheck-in: 3:00 PM\nCheck-out: 11:00 AM\nWi-Fi: Connect@AmericInn (no password)\nBreakfast: 6â€“10 AM\nFront Desk: 262-673-2200",
    "bot"
  );
};

/* Towels confirmation */
document.getElementById("towelBtn").onclick = () => {
  bubble(
    lang === "es"
      ? "Â¿Desea que llevemos toallas extra a su habitaciÃ³n ahora?"
      : "Would you like us to bring extra towels to your room now?",
    "bot"
  );

  const wrap = document.createElement("div");
  wrap.className = "confirmBar";

  const yes = document.createElement("button");
  yes.className = "chip primary";
  yes.type = "button";
  yes.textContent = lang === "es" ? "âœ… SÃ­, por favor" : "âœ… Yes, please";

  const no = document.createElement("button");
  no.className = "chip";
  no.type = "button";
  no.textContent = lang === "es" ? "âŒ No, cancelar" : "âŒ No, cancel";

  yes.onclick = () => { sendMessage("I need extra towels."); wrap.remove(); };
  no.onclick  = () => { bubble(lang === "es" ? "Solicitud cancelada." : "Request cancelled.", "bot"); wrap.remove(); };

  wrap.appendChild(yes);
  wrap.appendChild(no);
  chat.appendChild(wrap);
  chat.scrollTop = chat.scrollHeight;

  setTimeout(() => { try { input.focus(); } catch(e){} }, 150);
};

renderHistory();

/* focus on load */
setTimeout(() => { try { input.focus(); } catch(e){} }, 350);
</script>
</body>
</html>
