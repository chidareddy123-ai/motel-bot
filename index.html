<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Motel Assistant</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <div class="app">
    <header class="topbar">
      <div>
        <h1>Motel Assistant</h1>
        <p id="roomLine">Room: ‚Äî</p>
      </div>

      <div style="display:flex; gap:10px; align-items:center;">
        <select id="langSelect" class="ghost" aria-label="Language">
          <option value="en">English</option>
          <option value="es">Espa√±ol</option>
        </select>
        <button id="resetBtn" class="ghost">Reset</button>
      </div>
    </header>

    <main id="chat" class="chat"></main>

    <section class="quick">
      <button class="chip" data-msg="I need extra towels.">üßª Towels</button>
      <button class="chip" data-msg="I need toiletries like soap/shampoo.">üßº Toiletries</button>
      <button class="chip" data-msg="I have a maintenance issue in my room.">üîß Maintenance</button>
      <button class="chip" data-msg="Can I request a late checkout?">‚è∞ Late checkout</button>
      <button class="chip" data-msg="I need Wi-Fi help.">üì∂ Wi-Fi help</button>
      <button class="chip" data-msg="I want to report a noise complaint.">üîá Noise</button>
    </section>

    <footer class="composer">
      <input id="input" type="text" placeholder="Type your message..." autocomplete="off" />
      <button id="sendBtn" class="send">Send</button>
    </footer>
  </div>

<script>
/* =====================================================
   ‚úÖ Google Sheets Web App URL (ends with /exec)
   ===================================================== */
const SHEET_LOG_URL =
  "https://script.google.com/macros/s/AKfycbzxatP2NITNy0X10cyUo3jl5gcQnTA6qbohTqyXZB8aBimmaQ89jVGy4O6GB25gYirvhA/exec";
/* ===================================================== */

const params = new URLSearchParams(window.location.search);
let room = params.get("room") || localStorage.getItem("room") || "";

// Language preference (default English)
let lang = localStorage.getItem("lang") || "en";
const langSelect = document.getElementById("langSelect");
langSelect.value = lang;

langSelect.addEventListener("change", () => {
  lang = langSelect.value;
  localStorage.setItem("lang", lang);

  // Optional: show a tiny confirmation message in chat
  const msg = (lang === "es")
    ? "Idioma cambiado a Espa√±ol."
    : "Language set to English.";
  bubble(msg, "bot");
});

if (!room) {
  room = prompt("Enter your room number (example: 205):") || "";
  room = room.trim();
  if (room) localStorage.setItem("room", room);
}
document.getElementById("roomLine").textContent = room ? `Room: ${room}` : "Room: ‚Äî";

const chat = document.getElementById("chat");
const input = document.getElementById("input");
const sendBtn = document.getElementById("sendBtn");
const resetBtn = document.getElementById("resetBtn");

let messages = JSON.parse(localStorage.getItem("messages") || "[]");

function bubble(text, who) {
  const wrap = document.createElement("div");
  wrap.className = `bubble ${who}`;
  wrap.innerHTML = `<div class="msg"></div>`;
  wrap.querySelector(".msg").textContent = text;
  chat.appendChild(wrap);
  chat.scrollTop = chat.scrollHeight;
}

function renderHistory() {
  chat.innerHTML = "";
  if (messages.length === 0) {
    bubble(
      lang === "es"
        ? "¬°Hola! Puedo ayudarte con toallas, art√≠culos de aseo, Wi-Fi, salida tard√≠a y mantenimiento. ¬øQu√© necesitas?"
        : "Hi! I can help with towels, toiletries, Wi-Fi, late checkout, and maintenance. What do you need?",
      "bot"
    );
  } else {
    for (const m of messages) bubble(m.content, m.role === "user" ? "you" : "bot");
  }
}

/* =====================================================
   ‚úÖ Detect request type from guest text
   ===================================================== */
function detectType(text) {
  const t = (text || "").toLowerCase();

  if (t.includes("towel") || t.includes("toalla")) return "Towels";
  if (t.includes("toiletr") || t.includes("soap") || t.includes("shampoo") || t.includes("jab√≥n") || t.includes("champ√∫")) return "Toiletries";
  if (t.includes("housekeep") || t.includes("clean") || t.includes("limpiar") || t.includes("basura")) return "Housekeeping";
  if (t.includes("maint") || t.includes("broken") || t.includes("not working") || t.includes("repair") || t.includes("leak") || t.includes("ac") || t.includes("heat") || t.includes("tv") || t.includes("no funciona") || t.includes("gotea")) return "Maintenance";
  if (t.includes("late checkout") || t.includes("late check out") || t.includes("salida tarde") || t.includes("checkout tarde")) return "Late checkout";
  if (t.includes("wifi") || t.includes("wi-fi") || t.includes("internet") || t.includes("contrase√±a") || t.includes("red")) return "Wi-Fi help";
  if (t.includes("noise") || t.includes("loud") || t.includes("ruido") || t.includes("muy alto")) return "Noise";
  if (t.includes("pillow") || t.includes("blanket") || t.includes("almohada") || t.includes("manta")) return "Bedding";

  return "Other";
}

/* =====================================================
   ‚úÖ Log to Google Sheet (CORS-safe fire-and-forget)
   ===================================================== */
function logToSheet({ room, type, message }) {
  if (!SHEET_LOG_URL) return;

  fetch(SHEET_LOG_URL, {
    method: "POST",
    mode: "no-cors",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify({ room, type, message })
  }).catch(() => {});
}

/* =====================================================
   ‚úÖ Add a language instruction message to the AI
   ===================================================== */
function languageInstruction() {
  return (lang === "es")
    ? "Please reply in Spanish."
    : "Please reply in English.";
}

async function sendMessage(text) {
  if (!text) return;

  // Show + store user message
  messages.push({ role: "user", content: text });
  localStorage.setItem("messages", JSON.stringify(messages));
  bubble(text, "you");
  input.value = "";

  // Log every message
  logToSheet({ room, type: detectType(text), message: text });

  // Typing bubble
  bubble(lang === "es" ? "Escribiendo‚Ä¶" : "Typing‚Ä¶", "bot");
  const typing = chat.lastChild;

  try {
    // Include language instruction in the messages we send to the API
    const outgoing = [
      ...messages.slice(-9),
      { role: "user", content: languageInstruction() }
    ];

    const res = await fetch("/.netlify/functions/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ room, messages: outgoing })
    });

    const data = await res.json();
    typing.remove();

    const reply = data.reply || (lang === "es" ? "Lo siento‚Äîalgo sali√≥ mal." : "Sorry‚Äîsomething went wrong.");
    messages.push({ role: "assistant", content: reply });
    localStorage.setItem("messages", JSON.stringify(messages));
    bubble(reply, "bot");
  } catch (e) {
    typing.remove();
    bubble(lang === "es" ? "Error de red. Intenta de nuevo o llama a la recepci√≥n." : "Network error. Please try again or call the front desk.", "bot");
  }
}

sendBtn.addEventListener("click", () => sendMessage(input.value.trim()));
input.addEventListener("keydown", (e) => {
  if (e.key === "Enter") sendMessage(input.value.trim());
});

document.querySelectorAll(".chip").forEach(btn => {
  btn.addEventListener("click", () => sendMessage(btn.dataset.msg));
});

resetBtn.addEventListener("click", () => {
  localStorage.removeItem("messages");
  messages = [];
  renderHistory();
});

renderHistory();
</script>
</body>
</html>
