<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AmericInn Hartford ‚Äì Guest Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
</head>

<body>
<div class="app">

  <!-- ===== HEADER ===== -->
  <header class="topbar">
    <div class="brand">
      <div class="brandTop">
        <h1>AmericInn Hartford</h1>
        <span class="badge">Guest Assistant</span>
      </div>
      <p id="roomLine">Room: ‚Äî</p>
    </div>

    <div class="actions">
      <select id="langSelect" class="control">
        <option value="en">English</option>
        <option value="es">Espa√±ol</option>
      </select>

      <button id="infoBtn" class="control" type="button">Hotel Info</button>
      <button id="callBtn" class="control" type="button">Call</button>
      <button id="resetBtn" class="control" type="button">Reset</button>
    </div>
  </header>

  <!-- ===== CHAT ===== -->
  <main id="chat" class="chat"></main>

  <!-- ===== QUICK ACTIONS (ONLY 3 ‚Äì PREMIUM) ===== -->
  <section class="quick">
    <!-- Towels uses confirmation flow -->
    <button class="chip primary" type="button" id="towelBtn">üßª Need towels?</button>

    <!-- These two are normal one-tap -->
    <button class="chip" type="button" data-msg="I have a maintenance issue in my room.">üîß Maintenance</button>
    <button class="chip" type="button" data-msg="Can I request a late checkout?">‚è∞ Late checkout</button>
  </section>

  <!-- ===== INPUT ===== -->
  <footer class="composer">
    <input
      id="input"
      type="text"
      placeholder="Type your message‚Ä¶"
      autocomplete="off"
    />
    <button id="sendBtn" class="send" type="button">Send</button>
  </footer>

</div>

<script>
/* ================= CONFIG ================= */

const SHEET_LOG_URL =
  "https://script.google.com/macros/s/AKfycbzxatP2NITNy0X10cyUo3jl5gcQnTA6qbohTqyXZB8aBimmaQ89jVGy4O6GB25gYirvhA/exec";

const FRONT_DESK_PHONE = "2626732200";

/* ================= ELEMENTS ================= */

const chat = document.getElementById("chat");
const input = document.getElementById("input");
const sendBtn = document.getElementById("sendBtn");
const resetBtn = document.getElementById("resetBtn");
const langSelect = document.getElementById("langSelect");
const infoBtn = document.getElementById("infoBtn");
const callBtn = document.getElementById("callBtn");

/* ================= STATE ================= */

const params = new URLSearchParams(location.search);

let room = params.get("room") || localStorage.getItem("room") || "";
let lang = localStorage.getItem("lang") || "en";
let messages = JSON.parse(localStorage.getItem("messages") || "[]");

/* ================= INIT ================= */

langSelect.value = lang;

if (!room) {
  room = (prompt("Enter your room number (example: 106):") || "").trim();
  if (room) localStorage.setItem("room", room);
}

document.getElementById("roomLine").textContent =
  room ? `Room: ${room}` : "Room: ‚Äî";

/* ================= UI HELPERS ================= */

function bubble(text, who) {
  const el = document.createElement("div");
  el.className = `bubble ${who}`;
  el.textContent = text;
  chat.appendChild(el);
  chat.scrollTop = chat.scrollHeight;
}

function renderHistory() {
  chat.innerHTML = "";

  if (messages.length === 0) {
    bubble(
      lang === "es"
        ? "¬°Hola! Soy tu asistente del hotel. ¬øC√≥mo puedo ayudarte?"
        : "Hi! I‚Äôm your hotel assistant. How can I help you?",
      "bot"
    );
  } else {
    messages.forEach(m =>
      bubble(m.content, m.role === "user" ? "you" : "bot")
    );
  }
}

/* ================= LOGGING ================= */

function detectType(text) {
  const t = (text || "").toLowerCase();
  if (t.includes("towel") || t.includes("toalla")) return "Towels";
  if (t.includes("maint") || t.includes("broken") || t.includes("repair") || t.includes("leak") || t.includes("ac")) return "Maintenance";
  if (t.includes("late checkout") || t.includes("checkout tarde") || t.includes("salida tarde")) return "Late checkout";
  return "Other";
}

function logToSheet({ room, type, message }) {
  if (!SHEET_LOG_URL) return;
  fetch(SHEET_LOG_URL, {
    method: "POST",
    mode: "no-cors",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify({ room, type, message })
  }).catch(() => {});
}

function languageInstruction() {
  return lang === "es"
    ? "Please reply in Spanish."
    : "Please reply in English.";
}

/* ================= SEND MESSAGE ================= */

async function sendMessage(text) {
  if (!text) return;

  messages.push({ role: "user", content: text });
  localStorage.setItem("messages", JSON.stringify(messages));
  bubble(text, "you");
  input.value = "";

  logToSheet({ room, type: detectType(text), message: text });

  bubble(lang === "es" ? "Escribiendo‚Ä¶" : "Typing‚Ä¶", "bot");
  const typingEl = chat.lastChild;

  try {
    const outgoing = [
      ...messages.slice(-8),
      { role: "user", content: languageInstruction() }
    ];

    const res = await fetch("/.netlify/functions/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ room, messages: outgoing })
    });

    const data = await res.json();
    typingEl.remove();

    messages.push({ role: "assistant", content: data.reply });
    localStorage.setItem("messages", JSON.stringify(messages));
    bubble(data.reply, "bot");

  } catch {
    typingEl.remove();
    bubble(
      lang === "es"
        ? "Error de red. Llama a recepci√≥n."
        : "Network error. Please call the front desk.",
      "bot"
    );
  }
}

/* ================= EVENTS ================= */

// Send button + Enter key
sendBtn.onclick = () => sendMessage(input.value.trim());
input.onkeydown = e => e.key === "Enter" && sendMessage(input.value.trim());

// Chips (for buttons that still use data-msg)
document.querySelectorAll(".chip[data-msg]").forEach(btn =>
  btn.onclick = () => sendMessage(btn.dataset.msg)
);

// Reset
resetBtn.onclick = () => {
  localStorage.removeItem("messages");
  messages = [];
  renderHistory();
};

// Language change
langSelect.onchange = e => {
  lang = e.target.value;
  localStorage.setItem("lang", lang);
  renderHistory();
};

// Call front desk
callBtn.onclick = () => {
  window.location.href = `tel:${FRONT_DESK_PHONE}`;
};

// Hotel Info
infoBtn.onclick = () => {
  bubble(
    lang === "es"
      ? "üìç AmericInn Hartford\nCheck-in: 3:00 PM\nCheck-out: 11:00 AM\nWi-Fi: Connect@AmericInn (sin contrase√±a)\nDesayuno: 6‚Äì10 AM\nRecepci√≥n: 262-673-2200"
      : "üìç AmericInn Hartford\nCheck-in: 3:00 PM\nCheck-out: 11:00 AM\nWi-Fi: Connect@AmericInn (no password)\nBreakfast: 6‚Äì10 AM\nFront Desk: 262-673-2200",
    "bot"
  );
};

/* ================= TOWELS CONFIRMATION FLOW ================= */

const towelBtn = document.getElementById("towelBtn");

if (towelBtn) {
  towelBtn.addEventListener("click", () => {
    bubble(
      lang === "es"
        ? "¬øDesea que llevemos toallas extra a su habitaci√≥n ahora?"
        : "Would you like us to bring extra towels to your room now?",
      "bot"
    );

    const confirmWrap = document.createElement("div");
    confirmWrap.className = "quick";

    const yesBtn = document.createElement("button");
    yesBtn.className = "chip primary";
    yesBtn.type = "button";
    yesBtn.textContent = lang === "es" ? "‚úÖ S√≠, por favor" : "‚úÖ Yes, please";

    const noBtn = document.createElement("button");
    noBtn.className = "chip";
    noBtn.type = "button";
    noBtn.textContent = lang === "es" ? "‚ùå No, cancelar" : "‚ùå No, cancel";

    yesBtn.onclick = () => {
      sendMessage("I need extra towels.");
      confirmWrap.remove();
    };

    noBtn.onclick = () => {
      bubble(lang === "es" ? "Solicitud cancelada." : "Request cancelled.", "bot");
      confirmWrap.remove();
    };

    confirmWrap.appendChild(yesBtn);
    confirmWrap.appendChild(noBtn);
    chat.appendChild(confirmWrap);
    chat.scrollTop = chat.scrollHeight;
  });
}

/* ================= START ================= */
renderHistory();
</script>
</body>
</html>
