<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AmericInn Hartford â€“ Guest Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <div class="app">

    <!-- ===== HEADER ===== -->
    <header class="topbar">
      <div class="brand">
        <div class="brandTop">
          <h1>AmericInn Hartford</h1>
          <span class="badge">Guest Assistant</span>
        </div>
        <p id="roomLine">Room: â€”</p>
      </div>

      <div class="actions">
        <select id="langSelect" class="control" aria-label="Language">
          <option value="en">English</option>
          <option value="es">EspaÃ±ol</option>
        </select>

        <button id="infoBtn" class="control" type="button">Hotel Info</button>
        <button id="callBtn" class="control" type="button">Call</button>
        <button id="resetBtn" class="control" type="button">Reset</button>
      </div>
    </header>

    <!-- ===== CHAT ===== -->
    <main id="chat" class="chat"></main>

    <!-- ===== QUICK ACTIONS ===== -->
    <section class="quick">
      <button class="chip primary" type="button" data-msg="I need extra towels.">ğŸ§» Towels</button>
      <button class="chip" type="button" data-msg="I need toiletries like soap or shampoo.">ğŸ§¼ Toiletries</button>
      <button class="chip" type="button" data-msg="I have a maintenance issue in my room.">ğŸ”§ Maintenance</button>
      <button class="chip" type="button" data-msg="Can I request a late checkout?">â° Late checkout</button>
      <button class="chip" type="button" data-msg="I need Wi-Fi help.">ğŸ“¶ Wi-Fi help</button>
      <button class="chip" type="button" data-msg="I want to report a noise complaint.">ğŸ”‡ Noise</button>
    </section>

    <!-- ===== INPUT ===== -->
    <footer class="composer">
      <input id="input" type="text" placeholder="Type your messageâ€¦" autocomplete="off" />
      <button id="sendBtn" class="send" type="button">Send</button>
    </footer>

  </div>

<script>
/* ================= CONFIG ================= */

// Your Google Apps Script Web App URL (ends with /exec)
const SHEET_LOG_URL =
  "https://script.google.com/macros/s/AKfycbzxatP2NITNy0X10cyUo3jl5gcQnTA6qbohTqyXZB8aBimmaQ89jVGy4O6GB25gYirvhA/exec";

// Front desk phone
const FRONT_DESK_PHONE = "2626732200";

/* ================= ELEMENTS ================= */

const chat = document.getElementById("chat");
const input = document.getElementById("input");
const sendBtn = document.getElementById("sendBtn");
const resetBtn = document.getElementById("resetBtn");
const langSelect = document.getElementById("langSelect");
const infoBtn = document.getElementById("infoBtn");
const callBtn = document.getElementById("callBtn");

/* ================= STATE ================= */

const params = new URLSearchParams(location.search);

let room = params.get("room") || localStorage.getItem("room") || "";
let lang = localStorage.getItem("lang") || "en";
let messages = JSON.parse(localStorage.getItem("messages") || "[]");

/* ================= INIT ================= */

langSelect.value = lang;

if (!room) {
  room = (prompt("Enter your room number (example: 106):") || "").trim();
  if (room) localStorage.setItem("room", room);
}

document.getElementById("roomLine").textContent = room ? `Room: ${room}` : "Room: â€”";

/* ================= HELPERS ================= */

function bubble(text, who) {
  const el = document.createElement("div");
  el.className = `bubble ${who}`;
  el.textContent = text;
  chat.appendChild(el);
  chat.scrollTop = chat.scrollHeight;
}

function renderHistory() {
  chat.innerHTML = "";

  if (messages.length === 0) {
    bubble(
      lang === "es"
        ? "Â¡Hola! Soy tu asistente del hotel. Puedo ayudarte con toallas, artÃ­culos de aseo, Wi-Fi, salida tardÃ­a y mantenimiento. Â¿QuÃ© necesitas?"
        : "Hi! Iâ€™m your hotel assistant. I can help with towels, toiletries, Wi-Fi, late checkout, and maintenance. What do you need?",
      "bot"
    );
  } else {
    for (const m of messages) {
      bubble(m.content, m.role === "user" ? "you" : "bot");
    }
  }
}

/* ================= LOGGING ================= */

function detectType(text) {
  const t = (text || "").toLowerCase();
  if (t.includes("towel") || t.includes("toalla")) return "Towels";
  if (t.includes("toiletr") || t.includes("soap") || t.includes("shampoo") || t.includes("jabÃ³n") || t.includes("champÃº")) return "Toiletries";
  if (t.includes("maint") || t.includes("broken") || t.includes("repair") || t.includes("leak") || t.includes("ac") || t.includes("heat") || t.includes("no funciona") || t.includes("gotea")) return "Maintenance";
  if (t.includes("late checkout") || t.includes("checkout tarde") || t.includes("salida tarde")) return "Late checkout";
  if (t.includes("wifi") || t.includes("wi-fi") || t.includes("internet") || t.includes("contraseÃ±a")) return "Wi-Fi help";
  if (t.includes("noise") || t.includes("ruido") || t.includes("loud")) return "Noise";
  return "Other";
}

// Sends to Google Sheet (no-cors = no errors on browser)
function logToSheet({ room, type, message }) {
  if (!SHEET_LOG_URL) return;
  fetch(SHEET_LOG_URL, {
    method: "POST",
    mode: "no-cors",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify({ room, type, message })
  }).catch(() => {});
}

function languageInstruction() {
  return (lang === "es") ? "Please reply in Spanish." : "Please reply in English.";
}

/* ================= MAIN SEND ================= */

async function sendMessage(text) {
  if (!text) return;

  // Save + show user message
  messages.push({ role: "user", content: text });
  localStorage.setItem("messages", JSON.stringify(messages));
  bubble(text, "you");
  input.value = "";

  // Log to sheet
  logToSheet({ room, type: detectType(text), message: text });

  // Typing indicator
  bubble(lang === "es" ? "Escribiendoâ€¦" : "Typingâ€¦", "bot");
  const typingEl = chat.lastChild;

  try {
    // Use last messages + language instruction
    const outgoing = [
      ...messages.slice(-8),
      { role: "user", content: languageInstruction() }
    ];

    const res = await fetch("/.netlify/functions/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ room, messages: outgoing })
    });

    const data = await res.json();
    typingEl.remove();

    const reply = data.reply || (lang === "es" ? "Lo sientoâ€”algo saliÃ³ mal." : "Sorryâ€”something went wrong.");
    messages.push({ role: "assistant", content: reply });
    localStorage.setItem("messages", JSON.stringify(messages));
    bubble(reply, "bot");
  } catch (e) {
    typingEl.remove();
    bubble(lang === "es"
      ? "Error de red. Intenta de nuevo o llama a la recepciÃ³n."
      : "Network error. Please try again or call the front desk.",
      "bot"
    );
  }
}

/* ================= BUTTONS / EVENTS ================= */

sendBtn.addEventListener("click", () => sendMessage(input.value.trim()));

input.addEventListener("keydown", (e) => {
  if (e.key === "Enter") sendMessage(input.value.trim());
});

document.querySelectorAll(".chip").forEach(btn => {
  btn.addEventListener("click", () => sendMessage(btn.dataset.msg));
});

resetBtn.addEventListener("click", () => {
  localStorage.removeItem("messages");
  messages = [];
  renderHistory();
});

langSelect.addEventListener("change", () => {
  lang = langSelect.value;
  localStorage.setItem("lang", lang);
  renderHistory();
});

callBtn.addEventListener("click", () => {
  window.location.href = `tel:${FRONT_DESK_PHONE}`;
});

infoBtn.addEventListener("click", () => {
  const txt = (lang === "es")
    ? "ğŸ“ AmericInn Hartford\nâ€¢ Check-in: 3:00 PM\nâ€¢ Check-out: 11:00 AM\nâ€¢ Wi-Fi: Connect@AmericInn (sin contraseÃ±a)\nâ€¢ Desayuno: 6:00â€“10:00 AM (cerca de recepciÃ³n)\nâ€¢ Piscina: 8:00â€“10:00 PM\nâ€¢ Silencio: 11:00 PMâ€“7:00 AM\nâ€¢ RecepciÃ³n: 262-673-2200"
    : "ğŸ“ AmericInn Hartford\nâ€¢ Check-in: 3:00 PM\nâ€¢ Check-out: 11:00 AM\nâ€¢ Wi-Fi: Connect@AmericInn (no password)\nâ€¢ Breakfast: 6:00â€“10:00 AM (near front desk)\nâ€¢ Pool: 8:00â€“10:00 PM\nâ€¢ Quiet hours: 11:00 PMâ€“7:00 AM\nâ€¢ Front desk: 262-673-2200";
  bubble(txt, "bot");
});

/* ================= START ================= */
renderHistory();
</script>
</body>
</html>
